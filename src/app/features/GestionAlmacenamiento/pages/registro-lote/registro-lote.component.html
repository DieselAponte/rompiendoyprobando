<div class="form-container" *ngIf="lote; else estadoCarga">
    <h2>Registro de Lote</h2>
    <div class="lote-producto-detalle">
        <table mat-table [dataSource]="[lote]" class="mat-elevation-z2 detalle-lote-table">
            <ng-container matColumnDef="id">
                <th mat-header-cell *matHeaderCellDef>ID Lote</th>
                <td mat-cell *matCellDef="let item">{{ item.id }}</td>
            </ng-container>
            <ng-container matColumnDef="producto">
                <th mat-header-cell *matHeaderCellDef>Producto</th>
                <td mat-cell *matCellDef="let item">{{ item.idProducto?.nombreProducto || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="numeroLote">
                <th mat-header-cell *matHeaderCellDef>Número Lote</th>
                <td mat-cell *matCellDef="let item">{{ item.numeroLote }}</td>
            </ng-container>
            <ng-container matColumnDef="fechaVencimiento">
                <th mat-header-cell *matHeaderCellDef>Fecha Vencimiento</th>
                <td mat-cell *matCellDef="let item">{{ item.fechaVencimiento }}</td>
            </ng-container>
            <ng-container matColumnDef="cantidadInicial">
                <th mat-header-cell *matHeaderCellDef>Cant. Inicial</th>
                <td mat-cell *matCellDef="let item">{{ item.cantidadInicial }}</td>
            </ng-container>
            <ng-container matColumnDef="cantidadActual">
                <th mat-header-cell *matHeaderCellDef>Cant. Actual</th>
                <td mat-cell *matCellDef="let item">{{ item.cantidadActual }}</td>
            </ng-container>
            <ng-container matColumnDef="estado">
                <th mat-header-cell *matHeaderCellDef>Estado</th>
                <td mat-cell *matCellDef="let item">{{ item.estado || '—' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
    </div>

    <!-- Búsqueda de producto por código DIGEMID y agregado al lote -->
    <app-search-info-digemid (agregarProducto)="handleAgregarProducto($event)"></app-search-info-digemid>

    <!-- Tabla de productos que pertenecen al lote -->
    <app-prod-pertenece-lote [items]="productosDelLote"
        (eliminar)="handleEliminarProducto($event)"></app-prod-pertenece-lote>

    <!-- Observaciones y acciones de registro -->
    <app-observaciones-accion-registrar (registrarConIncidencia)="handleRegistrarConIncidencia($event)"
        (registrarLote)="handleRegistrarLote($event)"></app-observaciones-accion-registrar>
</div>

<ng-template #estadoCarga>
    <div class="loading">
        <p *ngIf="!errorCarga">Cargando información del lote...</p>
        <p *ngIf="errorCarga" class="error">{{ errorCarga }}</p>
    </div>
</ng-template>

<!-- Popup para registrar incidencia desde el formulario de registro de lote -->
<app-popup-registro-incidencia *ngIf="mostrarPopupIncidencia" (close)="cerrarPopupIncidencia()"
    (registrarIncidencia)="handleRegistrarIncidencia($event)">
</app-popup-registro-incidencia>